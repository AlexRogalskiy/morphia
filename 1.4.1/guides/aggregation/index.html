<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.66.0" />
    <meta name="description" content="">


    <link rel="icon" href="/1.4.1/images/favicon.png" type="image/png">

    <title>Aggregation :: Morphia</title>

    
    <link href="/1.4.1/css/nucleus.css?1584884003" rel="stylesheet">
    <link href="/1.4.1/css/fontawesome-all.min.css?1584884003" rel="stylesheet">
    <link href="/1.4.1/css/hybrid.css?1584884003" rel="stylesheet">
    <link href="/1.4.1/css/featherlight.min.css?1584884003" rel="stylesheet">
    <link href="/1.4.1/css/perfect-scrollbar.min.css?1584884003" rel="stylesheet">
    <link href="/1.4.1/css/auto-complete.css?1584884003" rel="stylesheet">
    <link href="/1.4.1/css/atom-one-dark-reasonable.css?1584884003" rel="stylesheet">
    <link href="/1.4.1/css/theme.css?1584884003" rel="stylesheet">
    <link href="/1.4.1/css/hugo-theme.css?1584884003" rel="stylesheet">
    

    <script src="/1.4.1/js/jquery-3.3.1.min.js?1584884003"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
        :not(pre) > code + span.copy-to-clipboard {
            display: none;
        }
      
    </style>
    <link href="/1.4.1/css/java.css" rel="stylesheet">
<link href="/1.4.1/css/theme-green.css" rel="stylesheet">

<style>
    :root {
        --MAIN-TEXT-color:#004042;  
        --MAIN-TITLES-TEXT-color: #004042;  
        --MAIN-LINK-color:#006cbc;  
        --MAIN-LINK-HOVER-color:#3f6d2c;  
        --MAIN-ANCHOR-color: #599a3e;  

        --MENU-HEADER-BG-color:#004042;  
        --MENU-HEADER-BORDER-color:#6ca439;  

        --MENU-SEARCH-BG-color:#006264;  
        --MENU-SEARCH-BOX-color: #84c767;  
        --MENU-SEARCH-BOX-ICONS-color: #c7f7c4;  

        --MENU-SECTIONS-ACTIVE-BG-color:#1b211c;  
        --MENU-SECTIONS-BG-color:#222723;  
        --MENU-SECTIONS-LINK-color: #ccc;  
        --MENU-SECTIONS-LINK-HOVER-color: #e6e6e6;   
        --MENU-SECTION-ACTIVE-CATEGORY-color: #777;  
        --MENU-SECTION-ACTIVE-CATEGORY-BG-color: #f3f4eb;  

        --MENU-VISITED-color: #599a3e;  
        --MENU-SECTION-HR-color: #18211c;  
    }

    body {
        background-color: var(--MENU-SECTION-ACTIVE-CATEGORY-BG-color);
        padding-top: 0;
    }

    h1 {
        color: var(--MAIN-TITLES-TEXT-color) !important;
    }

    strong {
        color: var(--MAIN-TITLES-TEXT-color) !important;
    }

    #top-bar-sticky-wrapper {
        visibility: hidden !important;
        min-height: 0;
    }

</style>

  </head>
  <body class="" data-url="/1.4.1/guides/aggregation/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="/1.4.1">
    <img src="/1.4.1/images/logo.png" alt="Morphia Logo"/>
</a>
<span id="version-tag">Morphia 1.4.1</span>

    </div>
    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          


 
  
    
    <li data-nav-id="/1.4.1/getting-started/" title="Getting Started" class="dd-item 
        
        
        
        ">
      <a href="/1.4.1/getting-started/">
          Getting Started
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/1.4.1/getting-started/installation-guide/" title="Installation Guide" class="dd-item ">
        <a href="/1.4.1/getting-started/installation-guide/">
        Installation Guide
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/1.4.1/getting-started/quick-tour/" title="Quick Tour" class="dd-item ">
        <a href="/1.4.1/getting-started/quick-tour/">
        Quick Tour
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/1.4.1/guides/" title="Reference Guides" class="dd-item 
        parent
        
        
        ">
      <a href="/1.4.1/guides/">
          Reference Guides
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/1.4.1/guides/annotations/" title="Annotations" class="dd-item ">
        <a href="/1.4.1/guides/annotations/">
        Annotations
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/1.4.1/guides/aggregation/" title="Aggregation" class="dd-item active">
        <a href="/1.4.1/guides/aggregation/">
        Aggregation
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/1.4.1/guides/indexing/" title="Indexing" class="dd-item ">
        <a href="/1.4.1/guides/indexing/">
        Indexing
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/1.4.1/guides/jrebel/" title="JRebel" class="dd-item ">
        <a href="/1.4.1/guides/jrebel/">
        JRebel
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/1.4.1/guides/lifecyclemethods/" title="Life Cycle Methods" class="dd-item ">
        <a href="/1.4.1/guides/lifecyclemethods/">
        Life Cycle Methods
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/1.4.1/guides/querying/" title="Querying" class="dd-item ">
        <a href="/1.4.1/guides/querying/">
        Querying
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/1.4.1/guides/schemavalidation/" title="Schema Validation" class="dd-item ">
        <a href="/1.4.1/guides/schemavalidation/">
        Schema Validation
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/1.4.1/guides/updating/" title="Updating" class="dd-item ">
        <a href="/1.4.1/guides/updating/">
        Updating
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/1.4.1/guides/validationextension/" title="Validation Extension" class="dd-item ">
        <a href="/1.4.1/guides/validationextension/">
        Validation Extension
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
         
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li> 
                  <a class="padding" href="/1.4.1/javadoc"><i class='fas fa-book'></i> API Documentation</a>
              </li>
          
              <li> 
                  <a class="padding" href="https://github.com/MorphiaOrg/morphia"><i class='fab fa-fw fa-github'></i> Source Code</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="footer">
      
    </section>
  </div>
</nav>





        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                   Aggregation 
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#the-pipeline">The Pipeline</a></li>
    <li><a href="#executing-the-pipeline">Executing the Pipeline</a>
      <ul>
        <li><a href="#aggregation-options">Aggregation Options</a></li>
        <li><a href="#out">$out</a></li>
        <li><a href="#typed-results">Typed Results</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Aggregation
            </h1>
          

        



<p>The <a href="http://docs.mongodb.org/manual/aggregation
">aggregation framework</a> in MongoDB allows you to define a series (called a pipeline) of
operations (called stages) against the data in a collection.  These pipelines can be used for analytics or they can be used to
convert your data from one form to another.  This guide will not go in to the details of how aggregation works, however.  The official
MongoDB <a href="http://docs.mongodb.org/manual/aggregation
">documentation</a> has extensive tutorials on such details.  Rather, this
guide will
focus on the Morphia API.  The examples shown here are taken from the <a href="https://github.com/MorphiaOrg/morphia/blob/r1.4.1/morphia/src/test/java/dev/morphia/aggregation/AggregationTest.java
">tests</a> in Morphia itself.</p>
<p>Writing an aggregation pipeline starts just like writing a standard query.  As with querying, we start with the <strong>Datastore</strong>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">Iterator<span style="color:#f92672">&lt;</span>Author<span style="color:#f92672">&gt;</span> aggregate <span style="color:#f92672">=</span> datastore<span style="color:#f92672">.</span><span style="color:#a6e22e">createAggregation</span><span style="color:#f92672">(</span>Book<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span>
      <span style="color:#f92672">.</span><span style="color:#a6e22e">group</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;author&#34;</span><span style="color:#f92672">,</span> grouping<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;books&#34;</span><span style="color:#f92672">,</span> push<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;title&#34;</span><span style="color:#f92672">)))</span>
      <span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">(</span>Author<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> options<span style="color:#f92672">);</span>
</code></pre></div><p><strong>createAggregation()</strong> takes a <strong>Class</strong> literal.  This lets Morphia know which collection to perform this aggregation
against.  Because of the transformational operations available in the aggregation <a href="http://docs.mongodb.org/manual/core/aggregation-pipeline
">pipeline</a>,
Morphia can not validate as much as it can with querying so care will need to be taken to ensure
document fields actually exist when referencing them in your pipeline.</p>
<h2 id="the-pipeline">The Pipeline</h2>
<p>Aggregation operations are comprised of a series stages.  Our example here has only one stage: <strong>group()</strong>.  This method is the Morphia
equivalent of the <a href="http://docs.mongodb.org/manual/reference/operator/aggregation/group/
"><strong>$group</strong></a> operator.  This stage, as the name
suggests, groups together documents based on the given field&rsquo;s values.  In this example, we are collecting together all the books by
author.  The first parameter to <strong>group()</strong> defines the _<strong>id</strong> of the resulting documents.  Within this grouping, this pipeline takes the
<strong>books</strong> fields for each author and extracts the <strong>title</strong>.  With this grouping of data, we&rsquo;re then __push()__ing the titles in to an array
in the final document.  This example is the Morphia equivalent of an <a href="http://docs.mongodb.org/manual/reference/operator/aggregation/group/#group-title-by-author
">example</a> found in the aggregation tutorials.  This results in a series of
documents that look like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{ <span style="color:#f92672">&#34;_id&#34;</span> : <span style="color:#e6db74">&#34;Homer&#34;</span>, <span style="color:#f92672">&#34;books&#34;</span> : [ <span style="color:#e6db74">&#34;The Odyssey&#34;</span>, <span style="color:#e6db74">&#34;Iliad&#34;</span> ] }
{ <span style="color:#f92672">&#34;_id&#34;</span> : <span style="color:#e6db74">&#34;Dante&#34;</span>, <span style="color:#f92672">&#34;books&#34;</span> : [ <span style="color:#e6db74">&#34;The Banquet&#34;</span>, <span style="color:#e6db74">&#34;Divine Comedy&#34;</span>, <span style="color:#e6db74">&#34;Eclogues&#34;</span> ] }
</code></pre></div><h2 id="executing-the-pipeline">Executing the Pipeline</h2>
<p>There are two basic ways to execute an aggregation pipeline:  <strong>aggregate()</strong> and <strong>out()</strong>.  These methods are Morphia&rsquo;s cues to send the
pipeline to MongoDB for execution.  In that regard, both are similar.  In practice, how the results are processed is even very similar.
The differences, however, can have huge implications on the performance of your application.  <strong>aggregate()</strong> by default will use the
&lsquo;inline&rsquo; method for returning the aggregation results.  This approach has the same 16MB limitation that all documents in MongoDB share.
We can changes this behavior using the <a href="http://api.mongodb.org/java/3.0/com/mongodb/AggregationOptions.html"><strong>AggregationOptions</strong></a>
class.  The <strong>options</strong> reference we passed to <strong>out()</strong> also applies to <strong>aggregate()</strong>.</p>
<h3 id="aggregation-options">Aggregation Options</h3>
<p>There are a handful options here but there&rsquo;s one that deserves some extra attention. As mentioned, the aggregation pipeline, by default,
returns everything &ldquo;inline&rdquo; but as of MongoDB 2.6 you can tell the aggregation framework to return a cursor instead.  This is what the
value of <a href="http://api.mongodb.org/java/3.0/com/mongodb/AggregationOptions.html#getOutputMode--">AggregationOptions#getOutputMode()</a>
determines.  By setting the output mode to <strong>CURSOR</strong>, MongoDB can return a result size much larger than 16MB.  The options can also be
configured to update the batch size or to set the time out threshold after which an aggregation will fail.  It is also possible to tell
the aggregation framework to use disk space which allows, among other things, sorting of larger data sets than what can fit in memory
on the server.</p>
<h3 id="out">$out</h3>
<p>But this example doesn&rsquo;t use <strong>aggregate()</strong>, of course, it uses <strong>out()</strong> which gives us access to the <strong>$out</strong> pipeline stage.  [<strong>$out</strong>]
(http://docs.mongodb.org/manual/reference/operator/aggregation/out/
) is a new operator in MongoDB 2.6 that allows the results of a
pipeline to be stored in to a named collection.  This collection can not be sharded or a capped collection, however.  This collection,
if it does not exist, will be created upon execution of the pipeline.</p>

<div class="notices warn" ><p>Any existing data in the collection will be replaced by the output of the aggregation.</p>
</div>

<p>Using <strong>out()</strong> is implicitly asking for the results to be returned via a cursor.  What is happening under the covers is the aggregation
framework is writing out to the collection and is done.  Morphia goes one extra step further and executes an implicit <strong>find</strong> on the output
collection and returns a cursor for all the documents in the collection.  In practice, this behaves no differently than setting the
output mode to <strong>CURSOR</strong> with <strong>aggregate()</strong> and your application need not know the difference.  It does, of course, have an impact on your
database and any existing data.  The use of <strong>$out</strong> and <strong>out()</strong> can be greatly beneficial in scenarios such as precomputed aggregated
results for later retrieval.</p>
<h3 id="typed-results">Typed Results</h3>
<p><strong>out()</strong> has several variants.  In this example, we&rsquo;re passing in <strong>Author.class</strong> which tells Morphia that we want to map each document
returned to an instance of <strong>Author</strong>.  Because we&rsquo;re using <strong>out()</strong> instead of <strong>aggregate()</strong>, Morphia will use the mapped collection for
<strong>Author</strong> as the output collection for the pipeline.  If you&rsquo;d like to use an alternate collection but still return a cursor of <strong>Author</strong>
instances, you can use [<strong>out(String,Class,AggregationOptions)</strong>](/javadoc/dev/morphia/aggregation/AggregationPipeline.html#out-java
.lang.String-java.lang.Class-com.mongodb.AggregationOptions-) instead.</p>


<footer class=" footline" >
	
</footer>


        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
        
        


	 
	 
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/1.4.1/js/clipboard.min.js?1584884003"></script>
    <script src="/1.4.1/js/perfect-scrollbar.min.js?1584884003"></script>
    <script src="/1.4.1/js/perfect-scrollbar.jquery.min.js?1584884003"></script>
    <script src="/1.4.1/js/jquery.sticky.js?1584884003"></script>
    <script src="/1.4.1/js/featherlight.min.js?1584884003"></script>
    <script src="/1.4.1/js/highlight.pack.js?1584884003"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/1.4.1/js/modernizr.custom-3.6.0.js?1584884003"></script>
    <script src="/1.4.1/js/learn.js?1584884003"></script>
    <script src="/1.4.1/js/hugo-learn.js?1584884003"></script>

    <link href="/1.4.1/mermaid/mermaid.css?1584884003" rel="stylesheet" />
    <script src="/1.4.1/mermaid/mermaid.js?1584884003"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    

  </body>
</html>

